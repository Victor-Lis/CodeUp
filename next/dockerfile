FROM node:22-alpine AS base
RUN apk add --no-cache g++ make py3-pip libc6-compat
RUN npm install -g pnpm

WORKDIR /app
COPY package*.json ./
EXPOSE 3000

FROM base AS builder
WORKDIR /app
COPY . .
RUN pnpm run build


FROM base AS production
WORKDIR /app
# ARG DATABASE_URL
# ARG NEXTAUTH_SECRET
# ARG NEXT_PUBLIC_API_BASE_URL
# ARG API_BASE_URL
# ARG NEXT_PUBLIC_FIREBASE_APIKEY
# ARG NEXT_PUBLIC_FIREBASE_AUTHDOMAIN
# ARG NEXT_PUBLIC_FIREBASE_PROJECTID
# ARG NEXT_PUBLIC_FIREBASE_STORAGEBUCKET
# ARG NEXT_PUBLIC_FIREBASE_MESSAGINGSENDERID
# ARG NEXT_PUBLIC_FIREBASE_APPID
# ARG NEXT_PUBLIC_FIREBASE_MEASUREMENTID
# ARG NEXT_PUBLIC_VALIDATOR_API_URL
ENV NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
ENV DATABASE_URL=${DATABASE_URL}
ENV NEXT_PUBLIC_API_BASE_URL=${NEXT_PUBLIC_API_BASE_URL}
ENV API_BASE_URL=${API_BASE_URL}
ENV NEXT_PUBLIC_FIREBASE_APIKEY=${NEXT_PUBLIC_FIREBASE_APIKEY}
ENV NEXT_PUBLIC_FIREBASE_AUTHDOMAIN=${NEXT_PUBLIC_FIREBASE_AUTHDOMAIN}
ENV NEXT_PUBLIC_FIREBASE_PROJECTID=${NEXT_PUBLIC_FIREBASE_PROJECTID}
ENV NEXT_PUBLIC_FIREBASE_STORAGEBUCKET=${NEXT_PUBLIC_FIREBASE_STORAGEBUCKET}
ENV NEXT_PUBLIC_FIREBASE_MESSAGINGSENDERID=${NEXT_PUBLIC_FIREBASE_MESSAGINGSENDERID}
ENV NEXT_PUBLIC_FIREBASE_APPID=${NEXT_PUBLIC_FIREBASE_APPID}
ENV NEXT_PUBLIC_FIREBASE_MEASUREMENTID=${NEXT_PUBLIC_FIREBASE_MEASUREMENTID}
ENV NEXT_PUBLIC_VALIDATOR_API_URL=${NEXT_PUBLIC_VALIDATOR_API_URL}
ENV NODE_ENV=production
RUN pnpm ci

RUN addgroup -g 1001 -S nodejs
RUN adduser -S nextjs -u 1001
USER nextjs


COPY --from=builder --chown=nextjs:nodejs /app/.next ./.next
# COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package.json ./package.json
COPY --from=builder /app/public ./public

CMD pnpm start

FROM base AS dev
ENV NODE_ENV=development
ENV NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
ENV DATABASE_URL=${DATABASE_URL}
ENV NEXT_PUBLIC_API_BASE_URL=${NEXT_PUBLIC_API_BASE_URL}
ENV API_BASE_URL=${API_BASE_URL}
ENV NEXT_PUBLIC_FIREBASE_APIKEY=${NEXT_PUBLIC_FIREBASE_APIKEY}
ENV NEXT_PUBLIC_FIREBASE_AUTHDOMAIN=${NEXT_PUBLIC_FIREBASE_AUTHDOMAIN}
ENV NEXT_PUBLIC_FIREBASE_PROJECTID=${NEXT_PUBLIC_FIREBASE_PROJECTID}
ENV NEXT_PUBLIC_FIREBASE_STORAGEBUCKET=${NEXT_PUBLIC_FIREBASE_STORAGEBUCKET}
ENV NEXT_PUBLIC_FIREBASE_MESSAGINGSENDERID=${NEXT_PUBLIC_FIREBASE_MESSAGINGSENDERID}
ENV NEXT_PUBLIC_FIREBASE_APPID=${NEXT_PUBLIC_FIREBASE_APPID}
ENV NEXT_PUBLIC_FIREBASE_MEASUREMENTID=${NEXT_PUBLIC_FIREBASE_MEASUREMENTID}
ENV NEXT_PUBLIC_VALIDATOR_API_URL=${NEXT_PUBLIC_VALIDATOR_API_URL}
RUN pnpm install 
COPY . .
CMD pnpm dev